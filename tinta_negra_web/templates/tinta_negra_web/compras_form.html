{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}

<div class="container-fluid px-4">

    <h2 class="text-white mt-4 fw-bold">üõí Registrar Compra</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mt-3" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="formCompra">
        {% csrf_token %}

        <!-- DATOS DE COMPRA -->
        <div class="card bg-dark text-white p-4 shadow-lg rounded-3 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold">Datos de la compra</h5>
                <span class="badge bg-info fs-6">
                    Saldo de Caja: ${{ caja_abierta.saldo_sistema|default:"0.00" }}
                </span>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">{{ form.proveedor.label }}</label>
                    {{ form.proveedor|add_class:"form-select" }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.empleado.label }}</label>
                    {{ form.empleado|add_class:"form-select" }}
                </div>

                <div class="col-md-4">
                    <label class="form-label">{{ form.forma_pago.label }}</label>
                    {{ form.forma_pago|add_class:"form-select" }}
                </div>

                <div class="col-md-4 mt-2">
                    <label class="form-label">{{ form.fecha.label }}</label>
                    {{ form.fecha|add_class:"form-control" }}
                </div>
            </div>

            <div class="mt-2">
                <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#proveedorModal">
                    ‚ûï Nuevo proveedor
                </button>
            </div>
        </div>

        <!-- DETALLE INSUMOS -->
        <div class="card bg-dark text-white p-4 shadow-lg rounded-3 mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold">Detalle de Insumos</h5>
                <button type="button" class="btn btn-primary btn-sm" id="add-row">‚ûï Agregar l√≠nea</button>
            </div>

            <table class="table table-dark table-hover align-middle rounded">
                <thead class="table-secondary text-dark">
                    <tr>
                        <th>Insumo</th>
                        <th style="width: 130px;">Cantidad</th>
                        <th style="width: 160px;">Precio Unitario</th>
                        <th style="width: 120px;">Subtotal</th>
                        <th style="width: 80px;">Acciones</th>
                    </tr>
                </thead>
                {{ formset.management_form }}
                <tbody id="detalle-body">
                    {{ formset.management_form }}

                    {% for f in formset %}
                    <tr class="detalle-row">
                        <!-- INSUMO -->
                        <td>
                            <div class="input-group">
                                {{ f.insumo|add_class:"form-select detalle-insumo" }}
                                <button type="button" class="btn btn-outline-info btn-sm"
                                        data-bs-toggle="modal" data-bs-target="#insumoModal">‚ûï</button>
                            </div>
                        </td>

                        <td>{{ f.cantidad|add_class:"form-control detalle-cantidad" }}</td>

                        <td>{{ f.precio_unitario|add_class:"form-control detalle-precio" }}</td>

                        <td>
                            <input type="text" class="form-control detalle-subtotal" readonly value="0.00">
                            {{ f.subtotal.as_hidden }}
                        </td>

                        <td class="text-center">
                            {{ f.DELETE }}
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>


            <h4 class="text-end mt-3">
                Total: <span class="text-success fw-bold">$<span id="total-compra">0.00</span></span>
            </h4>
        </div>

        <div class="mt-4 d-flex gap-2 justify-content-start">
            <button type="submit" class="btn btn-success px-4">‚úÖ Registrar compra</button>
            <a href="{% url 'compras_list' %}" class="btn btn-secondary px-4">‚ùå Cancelar</a>
        </div>

    </form>
</div>


<!-- üî• TEMPLATE FORMSET VAC√çO (fuera del formulario, fuera del tbody) -->
<script type="text/template" id="formset-empty">
<tr class="detalle-row">
    <td>
        <div class="input-group">
            {{ formset.empty_form.insumo|add_class:"form-select detalle-insumo" }}
            <button type="button" class="btn btn-outline-info btn-sm"
                    data-bs-toggle="modal" data-bs-target="#insumoModal">‚ûï</button>
        </div>
    </td>
    <td>{{ formset.empty_form.cantidad|add_class:"form-control detalle-cantidad" }}</td>
    <td>{{ formset.empty_form.precio_unitario|add_class:"form-control detalle-precio" }}</td>
    <td>
        <input type="text" class="form-control detalle-subtotal" readonly value="0.00">
        {{ formset.empty_form.subtotal.as_hidden }}
    </td>
    <td class="text-center">
        {{ formset.empty_form.DELETE }}
        <button type="button" class="btn btn-danger btn-sm btn-eliminar">
            <i class="fas fa-trash"></i>
        </button>
    </td>
</tr>
</script>



{% include 'tinta_negra_web/modals/proveedor_modal.html' %}
{% include 'tinta_negra_web/modals/insumo_modal.html' %}

<script>
    const INSUMO_PRECIOS = JSON.parse('{{ insumo_precios_json|escapejs }}');
</script>
<script src="{% static 'js/compras.js' %}"></script>

{% endblock %}
