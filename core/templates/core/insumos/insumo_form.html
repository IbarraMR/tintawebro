{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-3 text-white">{{ title }}</h2>
    <p class="text-secondary mb-4">
        Completa los campos para {{ is_create|yesno:"registrar un nuevo insumo,modificar los datos del insumo" }}.
    </p>

    <div class="card p-4" style="background-color:#1f1f1f; border:1px solid #333;">
        <form method="post">
            {% csrf_token %}


            <label class="form-label text-secondary">Proveedor <span class="text-danger">*</span></label>
            <div class="d-flex gap-2 mb-3">
                {{ form.proveedor }}
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalProveedor">
                    + proveedor
                </button>
            </div>


            <label class="form-label text-secondary">Nombre del insumo</label>
            {{ form.nombre }}

            <label class="form-label text-secondary mt-3">Descripción</label>
            {{ form.descripcion }}

            <div class="row mt-3">

                <div class="col-md-4">
                    <label class="form-label text-secondary">Unidad de medida</label>
                    <div class="d-flex gap-2 mb-3">
                        {{ form.unidad_medida }}
                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalUnidad">
                            + unidad
                        </button>
                    </div>

                    <label class="form-label text-secondary">Factor de conversión (rendimiento)</label>
                    {{ form.factor_conversion }}
                    <small class="text-secondary">Ej: resma → 500 hojas, plancha → 16 tapas A5</small>
                </div>

                <div class="col-md-4">
                    <label class="form-label text-secondary">Stock actual</label>
                    {{ form.stock_actual }}
                </div>

                <div class="col-md-4">
                    <label class="form-label text-secondary">Stock mínimo</label>
                    {{ form.stock_minimo }}
                </div>
            </div>


            <label class="form-label text-secondary mt-3">Precio costo unitario</label>
            {{ form.precio_costo_unitario }}

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-success">Guardar</button>
                <a href="{% url 'insumos_list' %}" class="btn btn-secondary">Cancelar</a>
            </div>

        </form>
    </div>
</div>


<div class="modal fade" id="modalProveedor" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="background-color:#1f1f1f; border:1px solid #333;">
      <div class="modal-header">
        <h5 class="modal-title text-white">Registrar Proveedor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formProveedorModal">
          {% csrf_token %}
          <input type="text" name="nombre" class="form-control mb-2" placeholder="Nombre" required>
          <input type="text" name="cuit" class="form-control mb-2" placeholder="CUIT" required>
          <input type="text" name="razon_social" class="form-control mb-2" placeholder="Razón social" required>
          <input type="text" name="telefono" class="form-control mb-2" placeholder="Teléfono" required>
          <input type="email" name="email" class="form-control mb-2" placeholder="Email" required>
          <input type="text" name="direccion" class="form-control mb-2" placeholder="Dirección" required>
          <input type="text" name="persona_contacto" class="form-control mb-2" placeholder="Persona de contacto" required>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnGuardarProveedor" class="btn btn-success">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>

document.getElementById("btnGuardarProveedor").addEventListener("click", function() {
    let formData = new FormData(document.getElementById("formProveedorModal"));

    fetch("{% url 'proveedor_create_ajax' %}", {
        method: "POST",
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            let select = document.getElementById("id_proveedor");
            let option = new Option(data.nombre, data.id, true, true);
            select.add(option);
            bootstrap.Modal.getInstance(document.getElementById("modalProveedor")).hide();
        }
    });
});
</script>


<div class="modal fade" id="modalUnidad" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="background-color:#1f1f1f; border:1px solid #333;">
      <div class="modal-header">
        <h5 class="modal-title text-white">Agregar unidad de medida</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formUnidadModal">
          {% csrf_token %}
          <input type="text" name="nombre" class="form-control" placeholder="Ej: resma / plancha / rollo" required>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnGuardarUnidad" class="btn btn-success">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("btnGuardarUnidad").addEventListener("click", function () {
    let formData = new FormData(document.getElementById("formUnidadModal"));
    fetch("{% url 'unidad_medida_create_ajax' %}", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let select = document.getElementById("id_unidad_medida");
            let option = new Option(data.nombre, data.id, true, true);
            select.add(option);
            bootstrap.Modal.getInstance(document.getElementById("modalUnidad")).hide();
        } else {
            console.log("Error en backend:", data.error);
        }
    })
});

</script>
{% endblock %}
