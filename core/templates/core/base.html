{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    
    <title>Tinta Negra | {% block title %}{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
</head>
<body>

{% if user.is_authenticated %}
<header class="main-header bg-dark text-white py-2 px-3 d-flex align-items-center">
    <a class="navbar-brand" href="/home">
        <img src="{% static 'core/logoTintaBlanco.png' %}" alt="TINTA NEGRA" style="height: 30px;">
    </a>
</header>
{% endif %}

<div class="main-layout d-flex">

{% if user.is_authenticated %}
<nav class="sidebar d-flex flex-column justify-content-between p-3" style="min-height: 100vh; width: 240px; background-color: #1c1c1c;">
    
    <div>
        <div class="sidebar-user text-white mb-3">
            <strong>Hola {{ request.user.username|title }}!</strong>
        </div>

        <ul class="nav flex-column">
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'home' %}">
                    <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                </a>
            </li>

            {% if perms.auth.add_user %} 
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'register' %}">
                    <i class="fas fa-user-plus me-2"></i> Registrar Usuario
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_clientes %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'clientes_list' %}">
                    <i class="fas fa-users me-2"></i> Clientes
                </a>
            </li>
            {% endif %}
            
            {% if perms.core.view_pedidos %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'pedidos_list' %}">
                    <i class="fas fa-clipboard-list me-2"></i> Pedidos
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_presupuestos %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'presupuestos_list' %}">
                    <i class="fas fa-file-invoice-dollar me-2"></i> Presupuestos
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_insumos %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'insumos_list' %}">
                    <i class="fas fa-box me-2"></i> Stock de insumos
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_cajas or perms.core.view_movimientoscaja %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'cajas_list' %}">
                    <i class="fas fa-cash-register me-2"></i> Caja
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_compras %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'compras_list' %}">
                    <i class="fas fa-shopping-cart me-2"></i> Compras
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_proveedores %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'proveedores_list' %}">
                    <i class="fas fa-truck-moving me-2"></i> Proveedores
                </a>
            </li>
            {% endif %}

            {% if perms.core.view_empleados %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'empleados_list' %}">
                    <i class="fas fa-user-tie me-2"></i> Empleados
                </a>
            </li>
            {% endif %}

            {% if perms.auth.change_group %}
            <li class="nav-item mb-1">
                <a class="nav-link text-white" href="{% url 'configuracion' %}">
                    <i class="fas fa-cogs me-2"></i> Configuraci칩n
                </a>
            </li>
            {% endif %}
        </ul>
    </div>

    <div class="mt-3">
        <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger w-100 btn-sm">
                <i class="fas fa-sign-out-alt me-2"></i> Cerrar sesi칩n
            </button>
        </form>
    </div>
</nav>
{% endif %}

<main class="main-content flex-grow-1">
    {% block content %}{% endblock %}
</main>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

<script>
    // Usamos delegaci칩n de eventos a nivel de documento para la M츼XIMA PRIORIDAD
    $(document).on('click', '.sidebar .nav-link, .dashboard-card', function(e) {
        
        // 游띔 ESTO ES LA PRIORIDAD M츼XIMA: Detenemos inmediatamente cualquier otro listener.
        e.stopImmediatePropagation(); 
        
        // Si no hacemos preventDefault, el doble clic no funciona correctamente a veces.
        e.preventDefault(); 

        var clickedElement = $(this);
        var correctUrl;

        // Si se hizo clic en el DIV de la tarjeta, buscamos la URL del enlace estirado.
        if (clickedElement.hasClass('dashboard-card')) {
            correctUrl = clickedElement.find('a.stretched-link').attr('href');
        } else {
            // Si es un enlace de la sidebar, usamos su propio href.
            correctUrl = clickedElement.attr('href');
        }

        if (correctUrl) {
            // Usamos un peque침o 'timeout' de 10ms. Esto puede ser la clave si el navegador
            // est치 ejecutando el script malicioso de forma AS칈NCRONA.
            setTimeout(function() {
                window.location.href = correctUrl;
            }, 10);
        }
    });

    // Peque침o parche para asegurar que el click en el enlace dentro de la tarjeta no se pierda.
    $(document).on('click', '.dashboard-card a', function(e) {
        e.stopImmediatePropagation();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
