{% extends 'core/base.html' %}
{% block title %}Movimientos de Caja{% endblock %}

{% block content %}
{% include "core/partials/toasts.html" %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white">Historial de Movimientos de Caja</h2>

    {% if perms.core.add_movimientoscaja %}
    <a href="{% url 'movimiento_create' %}" class="btn btn-success">
        <i class="fas fa-plus me-2"></i> Nuevo Movimiento
    </a>
    {% endif %}
</div>

<!-- FILTROS -->
<form method="GET" class="mb-3">
    <div class="input-group">

        <input type="text" 
               name="q" 
               class="form-control" 
               placeholder="Buscar por ID o descripción" 
               value="{{ filtro_busqueda }}">

        <input type="date" 
               name="desde" 
               class="form-control"
               value="{{ filtro_fecha_desde|default_if_none:'' }}">

        <input type="date" 
               name="hasta" 
               class="form-control"
               value="{{ filtro_fecha_hasta|default_if_none:'' }}">

        <select name="forma_pago" class="form-select">
            <option value="">Método de pago (todos)</option>
            {% for fp in formas_pago %}
            <option value="{{ fp.id_forma }}"
                {% if filtro_forma_pago == fp.id_forma|stringformat:"s" %}selected{% endif %}>
                {{ fp.nombre }}
            </option>
            {% endfor %}
        </select>

        <button class="btn btn-primary">Filtrar</button>

        {% if filtro_busqueda or filtro_fecha_desde or filtro_fecha_hasta or filtro_forma_pago %}
        <a href="{% url 'movimientos_list' %}" class="btn btn-secondary">Limpiar</a>
        {% endif %}

    </div>
</form>

<!-- TABLA -->
<div class="card p-4" style="background:#1f1f1f; border:1px solid #333;">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0 text-center" id="tablaMovimientos">

            <thead>
                <tr>
                    <th># Mov.</th>
                    <th>Fecha/Hora</th>
                    <th>Tipo</th>
                    <th>Monto ($)</th>
                    <th>Forma de Pago</th>
                    <th>Descripción</th>
                    <th>Caja #</th>
                    <th>Empleado</th>
                </tr>
            </thead>

            <tbody>
                {% for mov in movs %}
                <tr>
                    <td>{{ mov.id }}</td>
                    <td>{{ mov.fecha_hora }}</td>
                    <td>{{ mov.get_tipo_display }}</td>
                    <td>${{ mov.monto }}</td>
                    <td>{{ mov.forma_pago.nombre }}</td>
                    <td>{{ mov.descripcion }}</td>
                    <td>{{ mov.caja.id_caja }}</td>
                    <td>{{ mov.creado_por.nombre }} {{ mov.creado_por.apellido }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center text-secondary">
                        No hay movimientos registrados.
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

    <!-- PAGINACIÓN -->
    <nav aria-label="Paginación" class="mt-3">
        <ul class="pagination justify-content-center">

            {% if movs.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ movs.previous_page_number }}">&laquo; Anterior</a>
            </li>
            {% endif %}

            {% for num in movs.paginator.page_range %}
            <li class="page-item {% if movs.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if movs.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ movs.next_page_number }}">Siguiente &raquo;</a>
            </li>
            {% endif %}

        </ul>
    </nav>
</div>

<!-- MODAL NUEVO MOVIMIENTO -->
<div class="modal fade" id="modalMovimiento" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header border-secondary">
        <h5 class="modal-title">Registrar Movimiento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form id="formNuevoMovimiento" method="POST">
        {% csrf_token %}

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Tipo</label>
            <select name="tipo" class="form-select">
              <option value="INGRESO">Ingreso</option>
              <option value="EGRESO">Egreso</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Monto</label>
            <input type="number" name="monto" class="form-control" step="0.01" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Forma de Pago</label>
            <select name="forma_pago" class="form-select" required>
              {% for fp in formas_pago %}
                <option value="{{ fp.id_forma }}">{{ fp.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea name="descripcion" class="form-control" rows="3"></textarea>
          </div>

        </div>

        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>

      </form>

    </div>
  </div>
</div>

{% endblock %}
