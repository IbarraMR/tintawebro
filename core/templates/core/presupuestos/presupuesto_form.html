{% extends 'core/base.html' %}
{% load static %}

{% block title %}Nuevo Presupuesto{% endblock %}

{% block content %}

<div class="container mt-4">

  <h2 class="text-white mb-3">{{ title }}</h2>
  {% include "core/partials/toasts.html" %}

  <form method="post" id="formPresupuesto">
    {% csrf_token %}
    <input type="hidden" id="presupuesto_id" name="presupuesto_id"
           value="{{ presupuesto.id_presupuesto|default:'' }}">

    <div class="row mt-2">

      <div class="col-md-4">
        <label class="form-label text-white">Cliente</label>
        <div class="d-flex gap-2 mb-3">
          {{ form.id_cliente }}
          <button type="button" class="btn btn-outline-success"
                  data-bs-toggle="modal" data-bs-target="#modalCliente">+ cliente</button>
        </div>
      </div>

      <div class="col-md-4">
        <label class="form-label text-white">Fecha emisiÃ³n</label>
        {{ form.fecha_emision }}
      </div>

      <div class="col-md-4">
        <label class="form-label text-white">Fecha vencimiento</label>
        {{ form.fecha_vencimiento }}     
      </div>

    </div>

    <div class="row mt-2">
      <div class="col-md-6">
        <label class="form-label text-white">Costo de diseÃ±o ($)</label>
        {{ form.costo_diseno }}          
      </div>

      <div class="col-md-6">
        <label class="form-label text-white">Margen de ganancia (%)</label>
        {{ form.margen_ganancia }}        
      </div>
    </div>

    <hr class="text-secondary my-4">

    <div class="row g-2 align-items-end">
      <div class="col-md-6">
        <label class="form-label text-white">Trabajo</label>
        <input type="text" name="nombre_trabajo" id="nombre_trabajo" class="form-control">
      </div>

      <div class="col-md-2">
        <label class="form-label text-white">Cantidad</label>
        <input type="number" name="cantidad_trabajo" id="cantidad_trabajo"
               class="form-control" value="1" min="1" step="1">
      </div>

      <div class="col-md-2">
        <label class="form-label text-white">Costo diseÃ±o ($)</label>
        <input type="number" name="costo_diseno_trabajo" id="costo_diseno_trabajo"
               class="form-control" min="0" step="1" value="0">
      </div>

      <div class="col-md-2">
        <label class="form-label text-white">Margen (%)</label>
        <input type="number" name="margen_trabajo" id="margen_trabajo"
               class="form-control" min="0" max="100" step="1" value="0">
      </div>
    </div>

    <div class="mt-2">
      <label class="form-label text-white">DescripciÃ³n del trabajo</label>
      <textarea id="descripcion_trabajo" class="form-control" rows="2"></textarea>
    </div>

    <h4 class="text-white mt-4">Insumos del trabajo</h4>

    <table class="table table-dark table-bordered mt-2">
      <thead>
        <tr>
          <th>Insumo</th>
          <th>Cantidad</th>
          <th>Costo unit.</th>
          <th>Subtotal</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="insumos-body"></tbody>
    </table>

    <button type="button" class="btn btn-primary" id="add-insumo">+ Agregar insumo</button>
    <button type="button" id="btnAddTrabajo" class="btn btn-success ms-2">âž• AÃ±adir trabajo</button>
    <button type="button" class="btn btn-outline-warning ms-2"
            data-bs-toggle="modal" data-bs-target="#modalProductos">ðŸ“¦ Productos</button>

    <div class="mt-3 text-white">
      Subtotal insumos: $ <span id="subtotal-trabajo">0.00</span>
      &nbsp; | Precio unitario: $ <span id="unitario-trabajo">0.00</span>
      &nbsp; | Total trabajo: $ <span id="total-trabajo">0.00</span>
    </div>

    <hr class="text-secondary my-4">

    <h4 class="text-white mt-3">Trabajos agregados</h4>
    <div id="tabla-trabajos-wrapper">
      {% include "core/presupuestos/_tabla_trabajos.html" with presupuesto=presupuesto %}
    </div>

    <div class="mt-4">
      <strong class="text-white fs-5">
        Total del presupuesto: $ <span id="presupuesto-total">
          {{ presupuesto.total_presupuesto|default:"0.00" }}
        </span>
      </strong>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button id="btnFinalizar" class="btn btn-success disabled"
              disabled formaction="{% url 'presupuesto_confirmar' 0 %}">
        âœ… Finalizar presupuesto
      </button>

      <a href="{% url 'presupuestos_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>

    {% include 'core/presupuestos/_modal_cliente.html' %}

  </form>
</div>


<script>
  
let insumos = [
{% for insumo in insumos %}
  { id: "{{ insumo.id_insumo }}", nombre: "{{ insumo.nombre|escapejs }}",
    costo: "{{ insumo.precio_costo_unitario }}", factor: "{{ insumo.factor_conversion }}" }
  {% if not forloop.last %},{% endif %}
{% endfor %}
];
</script>

<script>
const tbody = document.getElementById("insumos-body");
const totalPresupuestoSpan = document.getElementById("presupuesto-total");
const btnFinalizar = document.getElementById("btnFinalizar");

function filaInsumo() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>
      <select class="form-select insumo-select" required>
        <option value="">Seleccione...</option>
        ${insumos.map(i => `<option value="${i.id}" data-costo="${i.costo}" data-factor="${i.factor}">${i.nombre}</option>`).join("")}
      </select>
    </td>
    <td><input type="number" class="form-control cantidad" min="1" step="1" value="1"></td>
    <td><input type="text" class="form-control costo-unitario" disabled></td>
    <td><input type="text" class="form-control subtotal-input" disabled></td>
    <td><button type="button" class="btn btn-danger btn-sm borrar">X</button></td>`;
  return tr;
}

function actualizarSubtotalTrabajo() {
  let subtotal = 0;
  document.querySelectorAll(".subtotal-input").forEach(inp => subtotal += parseFloat(inp.value) || 0);
  const costoDiseno = parseFloat(document.getElementById("costo_diseno_trabajo").value) || 0;
  let margen = Math.min(100, Math.max(0, parseInt(document.getElementById("margen_trabajo").value) || 0));
  const unitario = subtotal + costoDiseno + (subtotal * (margen / 100));
  const cantidad = Math.max(1, parseInt(document.getElementById("cantidad_trabajo").value || "1"));

  document.getElementById("subtotal-trabajo").textContent = subtotal.toFixed(2);
  document.getElementById("unitario-trabajo").textContent = unitario.toFixed(2);
  document.getElementById("total-trabajo").textContent = (unitario * cantidad).toFixed(2);
}

document.getElementById("add-insumo").addEventListener("click", () => tbody.appendChild(filaInsumo()));

tbody.addEventListener("change", (e) => {
  if (e.target.classList.contains("insumo-select")) {
    const opt = e.target.selectedOptions[0];
    const tr = e.target.closest("tr");
    const real = parseFloat(opt.dataset.costo || 0) / parseFloat(opt.dataset.factor || 1);
    tr.querySelector(".costo-unitario").value = real.toFixed(2);
    tr.querySelector(".subtotal-input").value =
      (real * parseInt(tr.querySelector(".cantidad").value)).toFixed(2);
    actualizarSubtotalTrabajo();
  }
});

tbody.addEventListener("input", (e) => {
  if (e.target.classList.contains("cantidad")) {
    const tr = e.target.closest("tr");
    const unit = parseFloat(tr.querySelector(".costo-unitario").value || 0);
    tr.querySelector(".subtotal-input").value = (unit * parseInt(e.target.value)).toFixed(2);
    actualizarSubtotalTrabajo();
  }
});

tbody.addEventListener("click", (e) => {
  if (e.target.classList.contains("borrar")) {
    e.target.closest("tr").remove();
    actualizarSubtotalTrabajo();
  }
});

async function asegurarPresupuestoId() {
  const clienteSelect = document.querySelector("[name='id_cliente']");
  if (!clienteSelect.value) {
    showToast("SeleccionÃ¡ un cliente primero", "danger");
    throw new Error("sin cliente");
  }

  let pid = document.getElementById("presupuesto_id").value;
  if (pid) return pid;

  const formData = new URLSearchParams();
  formData.append("cliente_id", clienteSelect.value);
  formData.append("csrfmiddlewaretoken", document.querySelector("input[name='csrfmiddlewaretoken']").value);

  const res = await fetch("{% url 'crear_presupuesto_borrador' %}", {
    method: "POST",
    headers: {"Content-Type": "application/x-www-form-urlencoded"},
    body: formData.toString()
  });

  const data = await res.json();
  document.getElementById("presupuesto_id").value = data.presupuesto_id;
  return data.presupuesto_id;
}

document.getElementById("btnAddTrabajo").addEventListener("click", async () => {
  try {
    const presupuestoId = await asegurarPresupuestoId();

    if (!tbody.querySelectorAll("tr").length) {
      showToast("AgregÃ¡ al menos un insumo", "danger");
      return;
    }

    const form = new URLSearchParams();
    form.append("csrfmiddlewaretoken", document.querySelector("input[name='csrfmiddlewaretoken']").value);
    form.append("nombre_trabajo", nombre_trabajo.value);
    form.append("descripcion_trabajo", descripcion_trabajo.value);
    form.append("cantidad_trabajo", cantidad_trabajo.value);
    form.append("costo_diseno_trabajo", costo_diseno_trabajo.value);
    form.append("margen_trabajo", margen_trabajo.value);

    document.querySelectorAll("#insumos-body tr").forEach(tr => {
      form.append("insumo[]", tr.querySelector(".insumo-select").value);
      form.append("cantidad[]", tr.querySelector(".cantidad").value);
    });

    const res = await fetch(`{% url 'agregar_trabajo' 0 %}`.replace("0", presupuestoId), {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: form.toString()
    });

    const data = await res.json();
    document.getElementById("tabla-trabajos-wrapper").innerHTML = data.tabla;
    totalPresupuestoSpan.textContent = data.total;

    showToast("Trabajo agregado âœ…");

    nombre_trabajo.value = "";
    descripcion_trabajo.value = "";
    cantidad_trabajo.value = "1";
    costo_diseno_trabajo.value = "0";
    margen_trabajo.value = "0";
    tbody.innerHTML = "";
    actualizarBotonFinalizar();

  } catch (e) { console.error(e); }
});

document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("btn-eliminar-trabajo")) {
    if (!confirm("Â¿Eliminar este trabajo?")) return;
    const id = e.target.dataset.id;

    await fetch(`{% url 'eliminar_trabajo' 0 %}`.replace("0", id), {
      method: "POST",
      headers: {"X-CSRFToken": document.querySelector("input[name='csrfmiddlewaretoken']").value}
    });

    const presupuestoId = document.getElementById("presupuesto_id").value;
    const res = await fetch(`{% url 'listar_trabajos' 0 %}`.replace("0", presupuestoId));
    const data = await res.json();

    document.getElementById("tabla-trabajos-wrapper").innerHTML = data.tabla;
    totalPresupuestoSpan.textContent = data.total;

    actualizarBotonFinalizar();
  }
});

function actualizarBotonFinalizar() {
  const pid = document.getElementById("presupuesto_id").value;
  if (pid) {
    btnFinalizar.classList.remove("disabled");
    btnFinalizar.removeAttribute("disabled");
    btnFinalizar.setAttribute("formaction", `/presupuesto/${pid}/confirmar/`);
  }
}

document.getElementById("id_fecha_emision").value = new Date().toISOString().split("T")[0];

function showToast(message, type="success") {
  const toastEl = document.createElement("div");
  toastEl.classList.add("toast", "text-bg-" + type, "border-0", "show", "position-fixed");
  toastEl.style.bottom = "20px";
  toastEl.style.right = "20px";
  toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div></div>`;
  document.body.appendChild(toastEl);
  setTimeout(() => toastEl.remove(), 2500);
}

document.addEventListener("DOMContentLoaded", () => document.getElementById("add-insumo").click());
</script>

{% endblock %}
