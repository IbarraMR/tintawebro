{% extends 'core/base.html' %}
{% load static %}

{% block title %}Nuevo Presupuesto{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="text-white mb-4">{{ title }}</h2>
  {% include "core/partials/toasts.html" %}

  <form method="post" id="formPresupuesto" class="bg-dark p-4 rounded shadow">
    {% csrf_token %}
    <input type="hidden" id="presupuesto_id" name="presupuesto_id"
           value="{{ presupuesto.id_presupuesto|default:'' }}">
    <input type="hidden" id="editar_trabajo_id" name="editar_trabajo_id" value="">

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <label class="form-label text-white">Cliente</label>
        <div class="d-flex gap-2">
          {{ form.id_cliente }}
          <button type="button" class="btn btn-outline-success btn-sm"
                  data-bs-toggle="modal" data-bs-target="#modalCliente">+ cliente</button>
        </div>
      </div>

      <script>
      document.addEventListener("DOMContentLoaded", () => {
          const selectCliente = document.getElementById("id_id_cliente");
          selectCliente?.addEventListener("change", function () {
              let presupuestoId = document.getElementById("presupuesto_id")?.value || "0";
              const idCliente = this.value;
              if (!idCliente) return;

              fetch("{% url 'presupuesto_set_cliente' 0 %}".replace("0", presupuestoId), {
                  method: "POST",
                  headers: {
                      "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                      "X-Requested-With": "XMLHttpRequest",
                      "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                  },
                  body: new URLSearchParams({ id_cliente: idCliente })
              })
              .then(r => r.json())
              .then(data => {
                  if (!data.ok) alert(data.error || "No se pudo guardar el cliente.");
              })
              .catch(err => console.error("Error AJAX:", err));
          });
      });
      </script>

      <div class="col-md-4">
        <label class="form-label text-white">Fecha emisiÃ³n</label>
        {{ form.fecha_emision }}
      </div>

      <script>
      document.addEventListener("DOMContentLoaded", () => {
          const hoy = new Date().toISOString().split("T")[0];
          const fEmision = document.getElementById("id_fecha_emision");
          if (fEmision) fEmision.setAttribute("min", hoy);
      });
      </script>

    </div>

    <hr class="text-secondary mb-4">

    <ul class="nav nav-tabs mb-4" id="tabTipoTrabajo">
      <li class="nav-item">
        <button class="nav-link active fw-bold" id="tab-trabajo" data-tipo="trabajo">
          ðŸ›  Trabajo personalizado
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link fw-bold" id="tab-producto" data-tipo="producto">
          Producto del catÃ¡logo
        </button>
      </li>
    </ul>

    <div id="seccion-trabajo" class="p-3 bg-black rounded shadow-sm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label text-white">Trabajo</label>
          <input type="text" id="nombre_trabajo" class="form-control"
                 placeholder="Ej: ImpresiÃ³n + Encuadernado">
        </div>

        <div class="col-md-2">
          <label class="form-label text-white">Cantidad</label>
          <input type="number" id="cantidad_trabajo" class="form-control" value="1" min="1">
        </div>

        <div class="col-md-2">
          <label class="form-label text-white">Costo diseÃ±o ($)</label>
          <input type="number" id="costo_diseno_trabajo" class="form-control" value="0" min="0">
        </div>

        <div class="col-md-2">
          <label class="form-label text-white">Margen (%)</label>
          <input type="number"
                  id="margen_trabajo"
                  class="form-control"
                  value="0"
                  min="0"
                  max="100">
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label text-white">DescripciÃ³n del trabajo</label>
        <textarea id="descripcion_trabajo" class="form-control" rows="2"
                  placeholder="Opcional: detalles del trabajo"></textarea>
      </div>

      <h4 class="text-white mt-4">Insumos del trabajo</h4>

      <table class="table table-dark table-bordered table-sm mt-2">
        <thead>
          <tr class="text-center">
            <th style="width: 38%">Insumo</th>
            <th style="width: 10%">Cant.</th>
            <th style="width: 16%">Costo unit.</th>
            <th style="width: 16%">Subtotal</th>
            <th style="width: 10%">Acciones</th>
          </tr>
        </thead>
        <tbody id="insumos-body"></tbody>
      </table>

      <button type="button" id="add-insumo" class="btn btn-primary btn-sm mt-2">
        + Agregar insumo
      </button>

      <div class="mt-4 text-white fs-6">
        <b>Subtotal insumos:</b> $ <span id="subtotal-trabajo">0.00</span><br>
        <b>Precio unitario:</b> $ <span id="unitario-trabajo">0.00</span><br>
        <b>Total trabajo:</b> $ <span id="total-trabajo">0.00</span>
      </div>

      <button type="button" id="btnAddTrabajo" class="btn btn-success mt-3">
        âž• AÃ±adir trabajo al presupuesto
      </button>

    </div>

    <!-- PRODUCTOS DEL CATALOGO -->
    <div id="seccion-producto" class="d-none mt-4 p-3 bg-black rounded shadow-sm">
      <h5 class="text-white mb-3">Seleccionar producto del catÃ¡logo</h5>

      <input type="text" id="buscadorProductos"
             class="form-control mb-3"
             placeholder="Buscar por nombre o tipo...">

      <div class="table-responsive">
        <table class="table table-dark table-hover table-sm align-middle">
          <thead>
            <tr class="text-center">
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Precio</th>
              <th>Cant.</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="productosBody">
            {% for prod in productos %}
            <tr class="producto-item"
                data-nombre="{{ prod.nombre|lower }}"
                data-tipo="{{ prod.tipo.nombre_tipo|lower }}">
              <td>{{ prod.nombre }}</td>
              <td class="text-center">{{ prod.tipo.nombre_tipo }}</td>
              <td class="text-end">${{ prod.precio|floatformat:2 }}</td>
              <td class="text-center">
                <input type="number" class="form-control form-control-sm input-cant-prod"
                       value="1" min="1">
              </td>
              <td class="text-center">
                <button type="button"
                        class="btn btn-sm btn-success btn-add-producto"
                        data-id="{{ prod.id_producto }}"
                        data-precio="{{ prod.precio }}">
                  Agregar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <nav class="mt-3">
        <ul id="paginacionProductos" class="pagination pagination-sm"></ul>
      </nav>
    </div>

    <hr class="text-secondary mt-4">

    <h4 class="text-white mt-3">Trabajos agregados</h4>

    <div id="contenedor-tabla-trabajos">
      {% include "core/presupuestos/_tabla_trabajos.html" with presupuesto=presupuesto %}
    </div>

    <div class="mt-4">
      <strong class="text-white fs-4">
        Total del presupuesto: $
        <span id="presupuesto-total">
          {{ presupuesto.total_presupuesto|default:"0.00" }}
        </span>
      </strong>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button id="btnFinalizar" class="btn btn-success disabled"
              disabled
              formaction="{% url 'presupuesto_confirmar' presupuesto.id_presupuesto %}">
          Finalizar presupuesto
      </button>


      <a href="{% url 'presupuestos_list' %}" class="btn btn-secondary">Cancelar</a>
    </div>

  </form>

  {% include "core/presupuestos/_modal_cliente.html" %}

</div>
<script type="text/template" id="template-insumo">
  <tr class="insumo-row">
    <td>
      <select class="form-select form-select-sm insumo-select">
        {% for insumo in insumos %}
        <option value="{{ insumo.id_insumo }}"
                data-costo="{{ insumo.precio_costo_unitario|default:'0' }}"
                data-factor="{{ insumo.factor_conversion|default:'1' }}">
          {{ insumo.nombre }}
        </option>
        {% endfor %}
      </select>
    </td>
    <td><input type="number" class="form-control form-control-sm cantidad-insumo" value="1" min="1"></td>
    <td><input type="text" class="form-control form-control-sm text-end costo-unit" value="0.00" readonly></td>
    <td class="text-end subtotal-cell">0.00</td>
    <td class="text-center">
      <button type="button" class="btn btn-danger btn-sm btn-del-insumo">
        <i class="fa-solid fa-trash"></i>
      </button>
    </td>
  </tr>
</script>

<!-- VALIDACIÃ“N MARGEN Y CAMPOS NUMÃ‰RICOS -->
<script>
document.addEventListener("input", function(e) {
  let id = e.target.id;

  if (id === "margen_trabajo") {
    let v = e.target.value.replace(/[^0-9]/g, "");
    if (v === "") v = "0";
    let num = parseInt(v);
    if (num < 0) num = 0;
    if (num > 100) num = 100;
    e.target.value = num.toString();
    return;
  }

  const campos = ["cantidad-insumo", "cantidad_trabajo", "costo_diseno_trabajo"];
  const esCampoValido =
    campos.some(c => e.target.classList.contains(c)) ||
    campos.includes(id);

  if (!esCampoValido) return;

  let v = e.target.value;
  v = v.replace(/[^0-9.]/g, "");
  if (v === "" || parseFloat(v) <= 0) v = "1";
  e.target.value = v;
});
</script>

<!-- CAMBIO ENTRE TABS -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabTrabajo = document.getElementById("tab-trabajo");
  const tabProducto = document.getElementById("tab-producto");
  const secTrabajo = document.getElementById("seccion-trabajo");
  const secProducto = document.getElementById("seccion-producto");

  tabTrabajo.addEventListener("click", (e) => {
    e.preventDefault();
    tabTrabajo.classList.add("active");
    tabProducto.classList.remove("active");
    secTrabajo.classList.remove("d-none");
    secProducto.classList.add("d-none");
  });

  tabProducto.addEventListener("click", (e) => {
    e.preventDefault();
    tabTrabajo.classList.remove("active");
    tabProducto.classList.add("active");
    secTrabajo.classList.add("d-none");
    secProducto.classList.remove("d-none");
  });
});
</script>

<!-- PAGINACIÃ“N Y BÃšSQUEDA PRODUCTOS -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const filas = Array.from(document.querySelectorAll(".producto-item"));
  const tablaBody = document.getElementById("productosBody");
  const paginacion = document.getElementById("paginacionProductos");
  const buscador = document.getElementById("buscadorProductos");

  let paginaActual = 1;
  const filasPorPagina = 6;

  function actualizarTablaProd() {
    const q = (buscador.value || "").toLowerCase();

    const filtrados = filas.filter(row =>
      row.dataset.nombre.includes(q) ||
      row.dataset.tipo.includes(q)
    );

    const totalPag = Math.max(1, Math.ceil(filtrados.length / filasPorPagina));
    paginaActual = Math.min(paginaActual, totalPag);

    const ini = (paginaActual - 1) * filasPorPagina;
    const vis = filtrados.slice(ini, ini + filasPorPagina);

    tablaBody.innerHTML = "";
    vis.forEach(row => tablaBody.appendChild(row));

    renderPag(totalPag);
  }

  function renderPag(total) {
    paginacion.innerHTML = "";
    if (total <= 1) return;

    for (let i = 1; i <= total; i++) {
      const li = document.createElement("li");
      li.classList.add("page-item");
      if (i === paginaActual) li.classList.add("active");

      li.innerHTML = `<a class="page-link" style="cursor:pointer;">${i}</a>`;
      li.onclick = () => {
        paginaActual = i;
        actualizarTablaProd();
      };

      paginacion.appendChild(li);
    }
  }

  buscador.addEventListener("input", () => {
    paginaActual = 1;
    actualizarTablaProd();
  });

  actualizarTablaProd();
});
</script>

<!-- REGLAS DE CÃLCULO -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  function recalcularTodos() {
    let subtotalInsumos = 0;

    document.querySelectorAll("#insumos-body tr").forEach(row => {
      const opt = row.querySelector(".insumo-select")?.selectedOptions[0];
      if (!opt) return;

      const costo = parseFloat(opt.dataset.costo || 0);
      const factor = parseFloat(opt.dataset.factor || 1);
      const cant = parseFloat(row.querySelector(".cantidad-insumo").value || 1);

      const precioUnit = costo / factor;
      const subtotal = precioUnit * cant;

      row.querySelector(".costo-unit").value = precioUnit.toFixed(2);
      row.querySelector(".subtotal-cell").textContent = subtotal.toFixed(2);

      subtotalInsumos += subtotal;
    });

    document.getElementById("subtotal-trabajo").textContent =
      subtotalInsumos.toFixed(2);

    recalcularTotalesTrabajo();
  }

  function recalcularTotalesTrabajo() {
    const subInsumos = parseFloat(document.getElementById("subtotal-trabajo").textContent);
    const dis = parseFloat(document.getElementById("costo_diseno_trabajo").value || 0);
    const marg = parseFloat(document.getElementById("margen_trabajo").value || 0);
    const cant = parseFloat(document.getElementById("cantidad_trabajo").value || 1);

    const costoBruto = subInsumos + dis;
    const precioUnit = costoBruto + (costoBruto * (marg / 100));
    const total = precioUnit * cant;

    document.getElementById("unitario-trabajo").textContent = precioUnit.toFixed(2);
    document.getElementById("total-trabajo").textContent = total.toFixed(2);
  }

  const btnAdd = document.getElementById("add-insumo");
  const body = document.getElementById("insumos-body");

  btnAdd?.addEventListener("click", () => {
    const temp = document.createElement("tbody");
    temp.innerHTML = document.getElementById("template-insumo").innerHTML.trim();
    const row = temp.firstElementChild;
    body.appendChild(row);

    row.querySelector(".insumo-select").addEventListener("change", recalcularTodos);
    row.querySelector(".cantidad-insumo").addEventListener("input", recalcularTodos);
    row.querySelector(".btn-del-insumo").addEventListener("click", () => {
      row.remove();
      recalcularTodos();
    });

    recalcularTodos();
  });

});
</script>

<script>
function initAgregarProducto() {
  document.querySelectorAll(".btn-add-producto").forEach(btn => {
    btn.addEventListener("click", function () {

      let presupuestoId = document.getElementById("presupuesto_id")?.value;
      if (!presupuestoId) {
        alert("No existe presupuesto activo.");
        return;
      }

      const cantidad = this.closest("tr").querySelector(".input-cant-prod").value;

      fetch("{% url 'agregar_producto_presupuesto' 0 %}".replace("0", presupuestoId), {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
        },
        body: new URLSearchParams({
          id_producto: this.dataset.id,
          cantidad: cantidad,
        })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.ok) {
          alert(data.error);
          return;
        }
        actualizarTablaTrabajo(data);
      })
      .catch(err => console.error("ERROR AJAX PRODUCTO:", err));
    });
  });
}

function actualizarTablaTrabajo(data) {
  const cont = document.getElementById("contenedor-tabla-trabajos");
  if (cont && data.tabla) cont.innerHTML = data.tabla;

  if (data.total) {
    document.getElementById("presupuesto-total").textContent = parseFloat(data.total).toFixed(2);

  }
  if (data.presupuesto_id) {
    const btnFinal = document.getElementById("btnFinalizar");

    btnFinal.classList.remove("disabled");
    btnFinal.removeAttribute("disabled");
    btnFinal.setAttribute("formaction",
        "{% url 'presupuesto_confirmar' 0 %}".replace("0", data.presupuesto_id)
    );
  }


  if (data.presupuesto_id) {
    document.getElementById("presupuesto_id").value = data.presupuesto_id;
  }

  const btnFin = document.getElementById("btnFinalizar");
  if (data.total > 0 && data.presupuesto_id) {
    btnFin.classList.remove("disabled");
    btnFin.disabled = false;
    btnFin.setAttribute(
      "formaction",
      "{% url 'presupuesto_confirmar' 0 %}".replace("0", data.presupuesto_id)
    );
  }

  initAccionesTablaTrabajos();
}


function initAccionesTablaTrabajos() {
  document.querySelectorAll(".btn-eliminar-trabajo").forEach(btn => {
    btn.addEventListener("click", function () {
      fetch("{% url 'eliminar_trabajo' 0 %}".replace("0", this.dataset.id), {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      })
      .then(r => r.json())
      .then(data => actualizarTablaTrabajo(data));
    });
  });

  const total = parseFloat(document.getElementById("presupuesto-total").textContent || "0");
  const btnFin = document.getElementById("btnFinalizar");
  if (total > 0) {
    btnFin.classList.remove("disabled");
    btnFin.disabled = false;
  } else {
    btnFin.classList.add("disabled");
    btnFin.disabled = true;
  }
}


document.addEventListener("DOMContentLoaded", () => {
  initAgregarProducto();
  initAccionesTablaTrabajos();
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const btnAddTrabajo = document.getElementById("btnAddTrabajo");

  btnAddTrabajo?.addEventListener("click", function () {

    let presupuestoId = document.getElementById("presupuesto_id")?.value;
    if (!presupuestoId) presupuestoId = "0";

    const nombre = document.getElementById("nombre_trabajo").value.trim();
    const cantidad = document.getElementById("cantidad_trabajo").value;
    const costo = document.getElementById("costo_diseno_trabajo").value;
    const margen = document.getElementById("margen_trabajo").value;
    const desc = document.getElementById("descripcion_trabajo").value.trim();

    if (!nombre) {
      alert("âš  Debe ingresar un nombre para el trabajo.");
      return;
    }

    let insumos = [];
    document.querySelectorAll("#insumos-body tr").forEach(row => {
      insumos.push({
        id_insumo: row.querySelector(".insumo-select").value,
        cantidad: row.querySelector(".cantidad-insumo").value,
        costo_unitario: row.querySelector(".costo-unit").value
      });
    });

    if (insumos.length === 0) {
      alert("âš  Debe agregar al menos un insumo.");
      return;
    }

    fetch("{% url 'agregar_trabajo' 0 %}".replace("0", presupuestoId), {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        "X-Requested-With": "XMLHttpRequest",
        "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
      },
      body: new URLSearchParams({
        nombre_trabajo: nombre,
        cantidad_trabajo: cantidad,
        costo_diseno_trabajo: costo,
        margen_trabajo: margen,
        descripcion_trabajo: desc,
        insumos_json: JSON.stringify(insumos),
        editar_trabajo_id: document.getElementById("editar_trabajo_id").value
      })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        alert(data.error || "OcurriÃ³ un error.");
        return;
      }
      actualizarTablaTrabajo(data);
      document.getElementById("editar_trabajo_id").value = "";
    })
    .catch(err => console.error("ERROR AJAX TRABAJO:", err));
  });
});
</script>

<script>
function actualizarBotonFinalizar(presupuestoId) {
  const btn = document.getElementById("btnFinalizar");
  if (!btn) return;
  
  btn.classList.remove("disabled");
  btn.removeAttribute("disabled");
  btn.setAttribute("formaction",
    `/presupuesto/${presupuestoId}/confirmar/`
  );
}

// Cada vez que actualizamos la tabla luego de un AJAX:
function actualizarTablaTrabajo(data) {
  const cont = document.getElementById("contenedor-tabla-trabajos");
  if (cont && data.tabla) cont.innerHTML = data.tabla;

  if (data.total) {
    document.getElementById("presupuesto-total").textContent =
      parseFloat(data.total).toFixed(2);
  }

  if (data.presupuesto_id) {
    actualizarBotonFinalizar(data.presupuesto_id);  // ðŸ‘ˆ CLAVE!
  }

  initAccionesTablaTrabajos();
}
</script>


{% endblock %}
