{% extends 'core/base.html' %}
{% load static %}

{% block title %}Proveedores | Listado{% endblock %}

{% block content %}

{% include "core/partials/toasts.html" %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white">Listado de Proveedores</h2>

    {% if perms.core.add_proveedores %}
    <a href="{% url 'proveedor_create' %}" class="btn btn-success">
        <i class="fas fa-plus me-2"></i> Registrar Nuevo Proveedor
    </a>
    {% endif %}
</div>

<form method="get" class="mb-3">
    <div class="input-group">
        <input type="text" 
               name="q" 
               class="form-control" 
               placeholder="Buscar por nombre, razón social, teléfono o CUIT"
               value="{{ query }}">

        <button type="submit" class="btn btn-primary">Buscar</button>

        {% if query %}
        <a href="{% url 'proveedores_list' %}" class="btn btn-secondary">Limpiar</a>
        {% endif %}
    </div>
</form>

<style>
    .fila-inactiva {
        background-color: #2a2a2a !important;
        opacity: 0.6;
    }
</style>

<div class="card p-4" style="background-color:#1f1f1f; border:1px solid #333;">
    {% if proveedores %}
    <div class="table-responsive">
        <table class="table table-dark table-hover mb-0">
            <thead>
                <tr class="text-center">
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>CUIT</th>
                    <th>Razón Social</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Dirección</th>
                    <th>Contacto</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                {% for proveedor in proveedores %}
                <tr class="{% if not proveedor.is_active %}fila-inactiva{% endif %}">
                    <td class="text-center">{{ proveedor.id_proveedor }}</td>
                    <td>{{ proveedor.nombre }}</td>
                    <td>{{ proveedor.cuit }}</td>
                    <td>{{ proveedor.razon_social }}</td>
                    <td>{{ proveedor.telefono }}</td>
                    <td>{{ proveedor.email }}</td>
                    <td>{{ proveedor.direccion }}</td>
                    <td>{{ proveedor.persona_contacto }}</td>

                    <td class="text-center">

                        {% if proveedor.is_active %}
                        <a href="{% url 'compras_proveedor' pk=proveedor.id_proveedor %}"
                           class="btn btn-sm btn-info me-1"
                           title="Ver compras">
                            <i class="fas fa-shopping-cart"></i>
                        </a>

                        <a href="{% url 'proveedor_edit' proveedor.id_proveedor %}"
                           class="btn btn-sm btn-primary me-1"
                           title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>

                        <button type="button"
                                class="btn btn-sm btn-danger btn-baja-proveedor"
                                data-id="{{ proveedor.id_proveedor }}"
                                data-nombre="{{ proveedor.nombre }}"
                                data-bs-toggle="modal"
                                data-bs-target="#modalBajaProveedor">
                            <i class="fas fa-trash-alt"></i>
                        </button>

                        {% else %}
                        <form action="{% url 'proveedor_reactivar' proveedor.id_proveedor %}"
                              method="post"
                              style="display:inline;">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-success" title="Reactivar">
                                <i class="fas fa-undo"></i>
                            </button>
                        </form>
                        {% endif %}

                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

    <nav class="mt-3">
        <ul class="pagination justify-content-center">

            {% if proveedores.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ proveedores.previous_page_number }}">
                    &laquo; Anterior
                </a>
            </li>
            {% endif %}

            {% for num in proveedores.paginator.page_range %}
            <li class="page-item {% if proveedores.number == num %}active{% endif %}">
                <a class="page-link" href="?q={{ query }}&page={{ num }}">{{ num }}</a>
            </li>
            {% endfor %}

            {% if proveedores.has_next %}
            <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ proveedores.next_page_number }}">
                    Siguiente &raquo;
                </a>
            </li>
            {% endif %}

        </ul>
    </nav>

    {% else %}
    <div class="alert alert-info text-center">No se encontraron proveedores.</div>
    {% endif %}
</div>

<!-- Modal Baja -->
<div class="modal fade" id="modalBajaProveedor" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Baja</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="textoBaja"></p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <a id="btnConfirmarBaja" class="btn btn-danger">Dar de Baja</a>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".btn-baja-proveedor").forEach(btn => {
        btn.addEventListener("click", () => {
            const id = btn.dataset.id;
            const nombre = btn.dataset.nombre;

            document.getElementById("textoBaja").innerHTML =
                `¿Seguro que quieres dar de baja al proveedor <strong>${nombre}</strong>?`;

            document.getElementById("btnConfirmarBaja")
                .setAttribute("href", `/proveedores/${id}/baja/`);
        });
    });
});
</script>

{% endblock %}
