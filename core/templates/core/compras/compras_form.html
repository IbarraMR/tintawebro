{% extends 'core/base.html' %}
{% block title %}Nueva Compra{% endblock %}

{% block content %}
<div class="container mt-4 text-white">

    <h2>Nueva Compra ðŸ›’</h2>

    <form method="POST">
        {% csrf_token %}

        <!-- PROVEEDOR -->
        <label>Proveedor:</label>
        <div class="input-group">
            {{ compra_form.proveedor }}
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalProveedor">
                + Nuevo
            </button>
        </div>

        <!-- INSUMO -->
        <label class="mt-3">Insumo:</label>
        <div class="input-group">
            {{ detalle_form.insumo }}
            <button type="button" class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalInsumo">
                + Nuevo
            </button>
        </div>

        <label class="mt-3">Cantidad:</label>
        {{ detalle_form.cantidad }}

        <label class="mt-3">Precio unitario:</label>
        {{ detalle_form.precio_unitario }}

        <button class="btn btn-success mt-4" type="submit">Guardar Compra</button>
    </form>
</div>


<!-- âœ… MODAL CREAR PROVEEDOR -->
<div class="modal fade" id="modalProveedor" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">

            <form id="formProveedor">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Proveedor</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    {{ proveedor_form.as_p }}
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-success" type="submit">Guardar</button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- âœ… MODAL CREAR INSUMO -->
<div class="modal fade" id="modalInsumo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">

            <form id="formInsumo">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Insumo</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    {{ insumo_form.as_p }}
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-success" type="submit">Guardar</button>
                </div>
            </form>

        </div>
    </div>
</div>


<!-- âœ… JAVASCRIPT PARA CREAR Y ACTUALIZAR SELECTS -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    // ðŸ‘‰ CREAR PROVEEDOR POR AJAX
    document.querySelector("#formProveedor").addEventListener("submit", async (e) => {
        e.preventDefault();
        let form = e.target;

        let resp = await fetch("{% url 'proveedor_create_ajax' %}", {
            method: "POST",
            body: new FormData(form)
        });

        let data = await resp.json();

        if (data.success) {
            let select = document.querySelector("#id_proveedor");
            let option = new Option(data.nombre, data.id);
            select.add(option, undefined);
            select.value = data.id;

            bootstrap.Modal.getInstance(document.getElementById("modalProveedor")).hide();
            form.reset();
        } else {
            alert("Error al crear proveedor");
        }
    });

    // ðŸ‘‰ CREAR INSUMO POR AJAX
    document.querySelector("#formInsumo").addEventListener("submit", async (e) => {
        e.preventDefault();
        let form = e.target;

        let resp = await fetch("{% url 'insumo_create_ajax' %}", {
            method: "POST",
            body: new FormData(form)
        });

        let data = await resp.json();

        if (data.success) {
            let select = document.querySelector("#id_insumo");
            let option = new Option(data.nombre, data.id);
            select.add(option, undefined);
            select.value = data.id;

            bootstrap.Modal.getInstance(document.getElementById("modalInsumo")).hide();
            form.reset();
        } else {
            alert("Error al crear insumo");
        }
    });

});
</script>

{% endblock %}
