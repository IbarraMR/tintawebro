{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Panel de control{% endblock %}

{% block content %}

<h2 class="mb-4 text-white">Panel de control</h2>

<div class="row g-4 mb-4">

    <!-- CAJA ACTUAL -->
    <div class="col-lg-6">
        <div class="p-4 h-100" style="background:#151515; border:1px solid #2b2b2b; border-radius:10px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="text-uppercase text-secondary small">Caja actual</div>

                    {% if caja_abierta %}
                        <h3 class="text-success mb-1">Abierta</h3>
                        <p class="text-info fs-4 fw-bold mb-0">
                            ${{ saldo_actual|floatformat:2|intcomma }}
                        </p>
                    {% else %}
                        <h3 class="text-danger mb-1">Cerrada</h3>
                        <p class="text-secondary fs-5 fw-bold mb-0">
                            √öltimo saldo: ${{ saldo_actual|floatformat:2|intcomma }}
                        </p>
                    {% endif %}
                </div>

                <i class="fas fa-cash-register fa-3x text-light opacity-75"></i>
            </div>

            <a href="{% url 'cajas_list' %}" class="text-secondary small">Ver movimientos de caja</a>
        </div>
    </div>

    <!-- PEDIDOS PENDIENTES -->
    <div class="col-lg-6">
        <div class="p-4 h-100" style="background:#151515; border:1px solid #2b2b2b; border-radius:10px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="text-uppercase text-secondary small">Pedidos pendientes</div>
                    <h3 class="text-white mb-0">{{ pedidos_pendientes_count }}</h3>
                </div>
                <i class="fas fa-clipboard-list fa-2x text-warning"></i>
            </div>

            {% if pedidos_pendientes %}
                <ul class="list-unstyled small text-secondary mt-3">
                    {% for p in pedidos_pendientes|slice:":3" %}
                        <li class="d-flex justify-content-between text-white">
                            #{{ p.id_pedido }} - {{ p.id_cliente.nombre }}
                            <span>${{ p.total_pedido|floatformat:0|intcomma }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-secondary small mt-3">No hay pedidos pendientes.</p>
            {% endif %}

            <a href="{% url 'pedidos_list' %}" class="text-secondary small">Ir a pedidos</a>
        </div>
    </div>

</div>

<!-- VENTAS + STOCK MINIMO -->
<div class="row g-4 mb-4">

    <!-- GRAFICO VENTAS -->
    <div class="col-lg-8">
        <div class="p-4 h-100" style="background:#151515; border:1px solid #2b2b2b; border-radius:10px;">

            <div class="d-flex justify-content-between mb-3">
                <h5 class="text-white mb-0">Ventas</h5>

                <div class="d-flex align-items-center gap-2">

                    <!-- Botones -->
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-light filtro" data-filtro="diario">Diario</button>
                        <button class="btn btn-outline-light filtro active" data-filtro="mensual">Mensual</button>
                        <button class="btn btn-outline-light filtro" data-filtro="anual">Anual</button>
                    </div>

                    <!-- PDF -->
                    <a id="btnPDF" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-file-pdf"></i>
                    </a>

                    <!-- Selector MES -->
                    <input type="month" id="selectorMes"
                        class="form-control form-control-sm"
                        style="width: 120px; background:#222; color:white;">
                </div>
            </div>

            <div style="height:260px;">
                <canvas id="graficoVentas"></canvas>
            </div>
        </div>
    </div>

    <!-- STOCK M√çNIMO -->
    <div class="col-lg-4">
        <div class="p-4 h-100" style="background:#151515; border:1px solid #2b2b2b; border-radius:10px;">
            <h5 class="text-white mb-3">Stock m√≠nimo</h5>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-secondary small">Insumos cr√≠ticos</span>
                <span class="fs-4 text-danger">{{ insumos_criticos_count }}</span>
            </div>

            {% if insumos_criticos %}
                <ul class="list-group list-group-flush small" style="max-height:180px; overflow-y:auto;">
                    {% for ins in insumos_criticos|slice:":5" %}
                        <li class="list-group-item d-flex justify-content-between"
                            style="background:#111; border-color:#222;">
                            <span class="text-white">{{ ins.nombre }}</span>
                            <span class="badge bg-danger">{{ ins.stock_actual }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-secondary small">No hay insumos en alerta.</p>
            {% endif %}

            <a href="{% url 'insumos_list' %}" class="btn btn-outline-danger btn-sm mt-3">
                Revisar insumos
            </a>
        </div>
    </div>

</div>

<!-- PEDIDOS RECIENTES -->
<div class="row g-4">
    <div class="col-12">
        <div class="p-4" style="background:#151515; border:1px solid #2b2b2b; border-radius:10px;">
            <h5 class="text-white mb-3">Pedidos recientes</h5>

            {% if pedidos_recientes %}
                <table class="table table-dark table-sm text-center mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Estado</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for p in pedidos_recientes %}
                        <tr>
                            <td>#{{ p.id_pedido }}</td>
                            <td>{{ p.id_cliente.nombre }}</td>
                            <td>{{ p.id_estado.nombre_estado }}</td>
                            <td>${{ p.total_pedido|floatformat:0|intcomma }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-secondary">No hay pedidos recientes.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

let chartVentas = null;
const ctx = document.getElementById("graficoVentas").getContext("2d");
const selectorMes = document.getElementById("selectorMes");
const btnPDF = document.getElementById("btnPDF");

// -------------------------------------------------------
// üî• Mes actual por defecto
// -------------------------------------------------------
const hoy = new Date();
const yyyy = hoy.getFullYear();
const mm = ("0" + (hoy.getMonth() + 1)).slice(-2);
const mesActual = `${yyyy}-${mm}`;
selectorMes.value = mesActual;

// -------------------------------------------------------
// üî• Cargar gr√°fico por FILTRO (diario / mensual / anual)
// -------------------------------------------------------
function cargarGraficoFiltro(filtro) {
    fetch(`/api/grafico/ventas/?filtro=${filtro}`)
        .then(res => res.json())
        .then(data => {
            if (chartVentas) chartVentas.destroy();

            chartVentas = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: "Ventas ($)",
                        data: data.valores,
                        borderColor: "#00ff88",
                        backgroundColor: "rgba(0,255,136,0.15)",
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: "#00ff88"
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: "white" } } },
                    scales: {
                        x: { ticks: { color: "white" }, grid: { color: "#333" }},
                        y: { ticks: { color: "white" }, grid: { color: "#333" }}
                    }
                }
            });
        });
}

// -------------------------------------------------------
// üî• Cargar gr√°fico por MES
// -------------------------------------------------------
function cargarGraficoMes(mes) {
    fetch(`/api/grafico/ventas/?mes=${mes}`)
        .then(r => r.json())
        .then(data => {

            if (chartVentas) chartVentas.destroy();

            chartVentas = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: "Ventas ($)",
                        data: data.valores,
                        borderColor: "#00ff88",
                        backgroundColor: "rgba(0,255,136,0.15)",
                        tension: 0.3,
                        pointRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        });
}

// -------------------------------------------------------
// üî• Botones: Diario / Mensual / Anual
// -------------------------------------------------------
document.querySelectorAll(".filtro").forEach(btn => {
    btn.addEventListener("click", () => {

        document.querySelectorAll(".filtro").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const filtro = btn.dataset.filtro;

        btnPDF.href = `/reportes/ventas/pdf/?filtro=${filtro}`;

        cargarGraficoFiltro(filtro);
    });
});

// -------------------------------------------------------
// üî• Selector de mes
// -------------------------------------------------------
selectorMes.addEventListener("change", function () {
    const mes = this.value;
    btnPDF.href = `/reportes/ventas/pdf/?mes=${mes}`;
    cargarGraficoMes(mes);
});

// -------------------------------------------------------
// üî• Carga inicial
// -------------------------------------------------------
document.addEventListener("DOMContentLoaded", () => {
    btnPDF.href = `/reportes/ventas/pdf/?mes=${mesActual}`;
    cargarGraficoMes(mesActual);
});

</script>

{% endblock %}
